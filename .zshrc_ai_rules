#!/bin/zsh
# AIåŠ©æ‰‹è§„åˆ™è‡ªåŠ¨åŠ è½½é…ç½®
# è¿™ä¸ªæ–‡ä»¶ç¡®ä¿PROJECT_RULES.mdåœ¨æ¯æ¬¡ä¼šè¯å¼€å§‹æ—¶è¢«è‡ªåŠ¨åŠ è½½å’ŒéªŒè¯

# è®¾ç½®ç¯å¢ƒå˜é‡
export PROJECT_RULES_PATH="/Users/a606/cloud_function_source/PROJECT_RULES.md"
export AI_MEMORY_CONFIG="/Users/a606/cloud_function_source/.ai_memory.json"
export AI_RULES_CACHE="/Users/a606/cloud_function_source/.rules_cache.json"
export AI_AUTO_LOAD_RULES="true"

# å®šä¹‰å¿«æ·å‘½ä»¤
alias check-rules='python -c "from ai_memory_config import AIMemorySystem; print(AIMemorySystem().get_rule_summary())"'
alias validate-file='python -c "import sys; from ai_memory_config import AIMemorySystem; m=AIMemorySystem(); issues=m.validate_file(sys.argv[1]); print(\"âœ… æ–‡ä»¶ç¬¦åˆè§„åˆ™\" if not issues else \"âŒ å‘ç°é—®é¢˜:\\n\" + \"\\n\".join(issues))"'
alias ai-memory='python -c "from ai_memory_config import AIMemorySystem; m=AIMemorySystem(); print(f\"ğŸ“Š ä¼šè¯æ•°: {m.memory.get(\"session_count\", 0)}\\nğŸ“… ä¸Šæ¬¡ä¼šè¯: {m.memory.get(\"last_session\", \"N/A\")}\\nâš ï¸  è¿è§„è®°å½•: {len(m.memory.get(\"common_violations\", []))}\")"'

# è‡ªåŠ¨è¿è¡Œè§„åˆ™æ£€æŸ¥ï¼ˆé™é»˜æ¨¡å¼ï¼‰
if [ "$AI_AUTO_LOAD_RULES" = "true" ]; then
    # æ£€æŸ¥è§„åˆ™æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [ -f "$PROJECT_RULES_PATH" ]; then
        # é™é»˜åŠ è½½è§„åˆ™åˆ°ç¼“å­˜
        python -c "from ai_memory_config import AIMemorySystem; AIMemorySystem()" 2>/dev/null
        
        # å¦‚æœæ˜¯äº¤äº’å¼ä¼šè¯ï¼Œæ˜¾ç¤ºæç¤º
        if [ -t 1 ]; then
            echo "ğŸ’¡ PROJECT_RULES.md å·²è‡ªåŠ¨åŠ è½½ (ä½¿ç”¨ 'check-rules' æŸ¥çœ‹)"
        fi
    fi
fi

# æ·»åŠ Gité’©å­æé†’
if [ -d ".git" ]; then
    # æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
    if git diff --quiet --exit-code 2>/dev/null; then
        :
    else
        echo "âš ï¸  æ£€æµ‹åˆ°æœªæäº¤çš„æ›´æ”¹ï¼Œè®°å¾—éµå®ˆä»£ç å®¡æŸ¥è§„åˆ™"
    fi
fi

# å®šä¹‰è§„åˆ™éªŒè¯å‡½æ•°
validate_action() {
    local action="$1"
    python -c "
from ai_memory_config import AIMemorySystem
import sys
m = AIMemorySystem()
if not m.check_rule_compliance('$action', {}):
    print('âŒ æ“ä½œå¯èƒ½è¿åè§„åˆ™: $action')
    sys.exit(1)
else:
    print('âœ… æ“ä½œç¬¦åˆè§„åˆ™')
"
}

# è¦†ç›–å±é™©å‘½ä»¤
alias rm='echo "âš ï¸  ä½¿ç”¨rmå‰è¯·ç¡®è®¤ç¬¦åˆè§„åˆ™"; command rm -i'
alias mv='echo "âš ï¸  ä½¿ç”¨mvå‰è¯·ç¡®è®¤ç¬¦åˆè§„åˆ™"; command mv -i'

# pyteståˆ«åï¼Œç¡®ä¿æµ‹è¯•ç¬¦åˆè§„åˆ™
alias pytest='echo "âœ… ä½¿ç”¨pytestæ‰§è¡Œæµ‹è¯•ï¼ˆç¬¦åˆè§„åˆ™ï¼‰"; command pytest --cov --cov-fail-under=80'

# æ·»åŠ æ—¥å¿—ç›¸å…³åˆ«å
alias log='echo "âŒ ç¦æ­¢æ‰‹å†™æ—¥å¿—ï¼ä½¿ç”¨loggeræ¨¡å—"; false'
alias print='echo "âš ï¸  è­¦å‘Š: é¿å…ä½¿ç”¨printï¼Œå»ºè®®ä½¿ç”¨logger"; command print'

echo "ğŸ“‹ AIè§„åˆ™å®ˆæŠ¤å·²æ¿€æ´» | ä½¿ç”¨ 'check-rules' æŸ¥çœ‹æ‰€æœ‰è§„åˆ™"